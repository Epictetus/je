#!/usr/bin/env ruby

# Set ENV for preloading jemalloc
lib_dir = File.expand_path('../lib/', File.dirname(__FILE__))
if File.exists? (lib_dir + "/jemalloc.so")
  puts "=> Injecting jemalloc..."
  ENV.store("LD_PRELOAD", lib_dir + "/jemalloc.so")
elsif File.exists? (lib_dir + "/jemalloc.bundle")
  puts "=> Injecting jemalloc..."
  ENV.store("DYLD_INSERT_LIBRARIES", lib_dir + "/jemalloc.bundle")
else
  puts "=> Skip injecting jemalloc. Your platform is not supported."
end

# fork(2) and exec(2)
pid = Process.fork
if pid.nil? then
  Kernel.exec *ARGV
else
  pid, status = Process.wait2
  Kernel.exit status.exitstatus
end
